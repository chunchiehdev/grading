# 測試文件

本文檔說明項目中所有測試文件的功能和目的，幫助開發者理解測試覆蓋範圍。

## 單元測試 (Unit Tests)

### `test/unit/ai-prompt-generation.test.ts`

**功能**: 測試 AI 生成提示邏輯

**實現**:

- **系統指令生成測試**：

  - 創建標準評分員系統指令，包含角色定義和評分要求
  - 檢查指令包含 "專業評分員"、"JSON" 格式要求、"雙引號" 使用規範
  - 驗證 JSON 語法規則（最後項目無逗號、避免換行符等）
  - 確保包含建設性回饋指導和改進方向

- **文件評分提示生成測試**：

  - 使用模擬的 `GeminiFileGradingRequest` 包含文件信息和評分標準
  - 測試標準包含：文件名（學生論文.pdf）、評分標準（論文評分標準）
  - 評分標準包含多個項目：內容品質（40分）、結構組織（30分）
  - 每個項目有分級描述（優秀、良好、普通、不足）
  - 驗證提示長度合理（>500字符）且包含總分計算

- **分類評分標準測試**：

  - 測試帶有類別的複雜評分標準（學術寫作、技術能力、創新思維）
  - 驗證類別和子項目的正確格式化和包含
  - 檢查總分計算的準確性（跨類別求和）

- **文本評分提示測試**：

  - 使用 `generateTextGradingPrompt` 處理純文本內容
  - 驗證文本內容正確嵌入到提示中
  - 確認使用簡化輸出格式（相比文件評分的複雜格式）

- **工具函數測試**：
  - 測試 `dedent` 函數移除文本前導空格的功能
  - 驗證處理空字符串和純空格字符串的邊緣情況

### `test/unit/authentication.test.ts`

**功能**: 測試身份驗證和授權系統

**詳細實現**:

- **會話管理測試**：

  - 模擬會話對象並測試 `getUserId` 函數從有效會話中提取用戶ID
  - 測試無效會話數據的處理（null、非字符串、空字符串）
  - 使用 `createUserSession` 測試會話創建，驗證會話設置和提交
  - 測試 `logout` 函數的會話銷毀功能

- **用戶檢索和管理測試**：

  - 模擬數據庫查詢測試 `getUser` 函數從數據庫獲取完整用戶信息
  - 測試處理數據庫中不存在的用戶（返回null）
  - 模擬數據庫連接錯誤並驗證錯誤處理邏輯
  - 測試 `updateUserRole` 函數更新用戶角色（TEACHER/STUDENT）
  - 驗證角色更新失敗時的錯誤拋出

- **Google OAuth 集成測試**：

  - 測試未配置OAuth環境變量時的錯誤處理（重定向到錯誤頁面）
  - 測試OAuth回調在未配置時的處理（重定向到不可用錯誤）
  - 驗證OAuth功能函數的存在性和配置要求
  - 測試OAuth配置驗證邏輯

- **角色權限控制測試**：

  - 測試 `requireAuth` 函數要求用戶認證並返回用戶信息
  - 測試未認證用戶的重定向到登錄頁面
  - 測試 `requireTeacher` 函數允許教師訪問教師專用資源
  - 測試學生訪問教師資源時的拒絕（重定向到未授權頁面）
  - 測試 `requireStudent` 函數的學生權限控制
  - 測試教師訪問學生專用資源時的拒絕

- **錯誤處理和邊緣情況**：
  - 測試OAuth回調中缺失授權碼的處理
  - 測試OAuth驗證失敗時的錯誤重定向
  - 測試未配置OAuth環境時的優雅降級處理

### `test/unit/file-processing.test.ts`

**功能**: 測試文件處理功能

**詳細實現**:

- **文件上傳操作測試**：

  - 模擬完整文件上傳工作流：存儲上傳 → 數據庫記錄創建 → PDF解析觸發
  - 使用 `TestFile` 類創建模擬文件並mock `arrayBuffer` 方法
  - 測試文件驗證錯誤（空文件、超大文件101MB）
  - 模擬存儲錯誤並測試錯誤類型映射（AUTH→auth, NETWORK→network, QUOTA→quota）
  - 測試數據庫創建失敗時的存儲清理邏輯
  - 測試不支持文件類型的處理（不觸發解析）
  - 測試文件名清理（移除特殊字符、限制長度）

- **狀態和內容管理測試**：

  - 測試 `updateFileParseStatus` 更新文件解析狀態（PENDING→COMPLETED→FAILED）
  - 測試解析狀態更新失敗的錯誤處理
  - 測試 `getUserFiles` 帶過濾和分頁的用戶文件檢索
  - 測試 `getFile` 單個文件檢索並驗證用戶授權
  - 測試文件不存在場景的處理

- **文件刪除和恢復測試**：

  - 測試已用於評分的文件執行軟刪除（設置deletedAt時間戳）
  - 測試未用於評分的文件執行硬刪除（從數據庫移除）
  - 測試 `restoreFile` 恢復軟刪除文件的功能

- **生命週期和維護測試**：

  - 測試 `getReadyFiles` 獲取準備評分的文件（解析完成且未過期）
  - 測試 `cleanupExpiredFiles` 清理過期文件功能
  - 測試無過期文件時的清理處理

- **錯誤處理和邊緣情況**：
  - 測試文件讀取失敗時的優雅錯誤處理
  - 測試數據庫查詢失敗時的回退值返回
  - 測試文件授權驗證邏輯（防止用戶訪問他人文件）

### `test/unit/grading-engine.test.ts`

**功能**: 測試評分引擎核心邏輯

**詳細實現**:

- **核心評分工作流測試**：

  - 模擬完整評分流程：獲取評分結果 → 檢查狀態 → 調用AI服務 → 保存結果
  - 創建模擬評分結果包含上傳文件、評分標準和評分會話
  - 模擬Gemini服務成功響應並驗證結果保存
  - 測試非待處理結果的跳過邏輯（已完成的評分不重複處理）

- **數據驗證測試**：

  - 測試缺失評分結果的處理（返回"Grading result not found"錯誤）
  - 測試缺失必需數據（文件或評分標準為null）的驗證
  - 測試未解析文件內容的處理（parsedContent為null）
  - 驗證評分標準格式解析（JSON格式和類別結構）

- **數據庫操作測試**：

  - 測試數據庫連接失敗的錯誤處理
  - 驗證評分進度的數據庫更新（10% → 30% → 80% → 100%）
  - 測試缺失評分標準項目的處理
  - 驗證評分結果的最終數據庫保存（包含模型信息和token數量）

- **錯誤處理測試**：
  - 測試數據庫查詢異常的捕獲和處理
  - 驗證評分失敗時的狀態更新為FAILED
  - 測試致命錯誤時的清理和狀態更新

### `test/unit/grading-validation.test.ts`

**功能**: 測試評分結果驗證邏輯

**詳細實現**:

- **有效結果驗證測試**：

  - 測試標準評分結果結構（totalScore、maxScore、breakdown數組）
  - 驗證每個breakdown項目包含criteriaId、score、feedback
  - 確保有效分數和有意義的反饋內容（長度>20字符）

- **無效結果拒絕測試**：

  - 測試各種無效結構：缺失totalScore、無效breakdown、空對象等
  - 測試全零分且無有效反饋的結果拒絕
  - 測試包含錯誤信息的反饋拒絕（"評分失敗"、"JSON解析錯誤"）

- **邊緣情況處理測試**：

  - 測試null、undefined、非對象類型的處理
  - 測試breakdown為非數組的情況
  - 測試分數類型錯誤（非數字）的驗證
  - 測試空陣列breakdown的處理

- **AI響應模式驗證測試**：
  - 測試真實Gemini API響應格式的驗證
  - 測試真實OpenAI API響應格式的驗證
  - 確保兩種AI服務的響應都能通過驗證

## (Integration Tests)

### `test/integration/ai-grading-fallback.test.ts`

**功能**: 測試 AI 評分回退機制

**詳細實現**:

- **成功評分場景測試**：

  - 創建完整的評分場景：教師、學生、評分標準、上傳文件、評分會話
  - 測試Gemini文件上傳成功的第一次嘗試
  - 使用 `GradingResultFactory.createGeminiResult` 模擬成功的Gemini評分
  - 驗證評分結果包含預期的分數分解和反饋

- **服務商回退測試**：

  - 模擬Gemini服務失敗（網絡錯誤、API錯誤等）
  - 測試系統自動切換到OpenAI服務
  - 驗證回退過程中的錯誤記錄和重試邏輯
  - 確保最終使用OpenAI服務成功完成評分

- **方法回退測試**：

  - 測試文件評分失敗時回退到文本評分
  - 模擬文件處理錯誤（文件損壞、格式不支持等）
  - 驗證系統使用解析後的文本內容進行評分
  - 測試跨服務商的方法回退（Gemini文件 → OpenAI文件 → Gemini文字 → OpenAI文字）

- **完全失敗處理測試**：
  - 模擬所有AI服務和方法都失敗的極端情況
  - 測試系統的錯誤處理和用戶友好的錯誤消息
  - 驗證失敗狀態的正確記錄和報告

### `test/integration/complete-workflow-demo.test.ts`

**功能**: 完整工作流演示測試

**詳細實現**:

- **學術機構設置階段**：

  - 創建教授用戶（Dr. Sarah Martinez）和3個學生用戶
  - 創建詳細的學術論文評分標準（論文論述、研究證據、分析深度、寫作質量、引用格式）
  - 每個標準包含5個等級（優秀30分 → 不足0分）
  - 創建學術課程（Advanced Academic Writing）

- **課程結構建立階段**：

  - 創建作業區域並關聯評分標準
  - 設置詳細的作業描述和要求
  - 驗證課程、作業區域和評分標準的正確關聯

- **學生提交階段**：

  - 每個學生上傳PDF文件（不同的學術主題）
  - 模擬文件解析過程（PDF → 文本內容）
  - 創建學生提交記錄並關聯到作業區域

- **AI評分處理階段**：

  - 創建評分會話並生成評分結果
  - 模擬AI評分過程的各個階段（文件分析、標準應用、反饋生成）
  - 驗證評分結果的完整性和準確性

- **數據流和狀態驗證**：
  - 驗證從課程創建到最終評分的完整數據流
  - 檢查各個階段的狀態變化和記錄
  - 確保多用戶場景下的數據一致性

### `test/integration/grading-engine-validation.test.ts`

**功能**: 評分引擎集成驗證測試

**詳細實現**:

- **組件集成測試**：

  - 測試評分引擎與文件處理服務的集成
  - 驗證評分引擎與AI服務（Gemini/OpenAI）的通信
  - 測試評分引擎與數據庫的數據流集成
  - 驗證評分引擎與進度追蹤系統的整合

- **工作流驗證測試**：
  - 測試評分流程的各個步驟順序執行
  - 驗證評分狀態轉換（PENDING → PROCESSING → COMPLETED/FAILED）
  - 測試評分會話和結果的關聯管理
  - 驗證批量評分的處理能力

### `test/integration/multi-user-enrollment.test.ts`

**功能**: 多用戶註冊流程測試

**詳細實現**:

- **批量註冊場景測試**：

  - 創建課程和多個學生用戶
  - 測試學生使用邀請代碼批量註冊課程
  - 驗證註冊記錄的正確創建和關聯
  - 測試重複註冊的防護機制

- **並發處理測試**：

  - 模擬多個學生同時註冊同一課程
  - 測試系統對並發請求的處理能力
  - 驗證註冊數量限制的執行
  - 測試併發場景下的錯誤處理

- **數據一致性驗證**：
  - 確保多用戶操作後的數據完整性
  - 驗證註冊狀態的一致性
  - 測試事務性操作的原子性
  - 檢查外鍵約束的維護

### `test/integration/rubric-versioning-templates.test.ts`

**功能**: 評分標準版本管理測試

**詳細實現**:

- **版本控制測試**：

  - 測試評分標準的版本創建和管理
  - 驗證版本號的自動遞增和追蹤
  - 測試版本間的差異記錄和比較
  - 驗證版本回滾功能

- **模板系統測試**：

  - 測試評分標準模板的創建和標記
  - 驗證模板的複製和實例化功能
  - 測試模板權限管理（公開/私有）
  - 驗證模板的搜索和分類功能

- **向後兼容性測試**：
  - 測試新版本評分標準對已有評分的影響
  - 驗證歷史評分結果的訪問和顯示
  - 測試評分標準更新時的數據遷移
  - 確保API接口的向後兼容性

### `test/integration/student-submission-workflow.test.ts`

**功能**: 學生提交工作流測試

**詳細實現**:

- **文件上傳和處理流程**：

  - 測試學生註冊課程並訪問作業區域
  - 驗證PDF文件上傳和存儲過程
  - 測試文件解析服務的調用和處理
  - 驗證解析內容的保存和關聯

- **AI分析集成測試**：

  - 測試文件上傳後自動觸發AI分析
  - 驗證AI服務對上傳文件的處理
  - 測試分析結果的保存和格式化
  - 驗證分析進度的實時更新

- **提交記錄管理測試**：
  - 測試學生提交記錄的創建和關聯
  - 驗證提交狀態的追蹤和更新
  - 測試多次提交的版本管理
  - 驗證提交截止時間的控制

### `test/integration/teacher-grading-workflow.test.ts`

**功能**: 教師評分工作流測試

**詳細實現**:

- **評分流程集成測試**：

  - 測試教師查看學生提交列表的完整流程
  - 驗證評分會話的創建和管理
  - 測試批量評分的啟動和監控
  - 驗證評分結果的審核和確認

- **反饋系統測試**：

  - 測試教師添加額外評語和建議的功能
  - 驗證最終成績的計算和調整
  - 測試反饋的發送和通知機制
  - 驗證學生查看反饋的權限控制

- **工作流協調測試**：
  - 測試教師端與AI評分系統的協作
  - 驗證手動評分與AI評分的結合
  - 測試評分標準的實時應用
  - 驗證評分歷史的記錄和追蹤

## 負載測試 (Load Tests)

### `test/load/gemini-mock-load.test.ts`

**功能**: Gemini API 模擬負載測試

**詳細實現**:

- **模擬負載生成測試**：

  - 創建大量模擬的Gemini API請求（50-100個並發）
  - 使用mock responses模擬不同的響應時間和結果
  - 測試系統在高並發下的穩定性和響應能力
  - 監控內存使用和CPU負載

- **並發處理能力測試**：

  - 測試同時處理多個評分請求的能力
  - 驗證請求隊列的管理和調度算法
  - 測試連接池的效率和資源回收
  - 驗證併發限制和流量控制機制

- **錯誤處理和恢復測試**：
  - 模擬不同類型的API錯誤（超時、5xx錯誤、網絡中斷）
  - 測試錯誤重試邏輯和指數回退算法
  - 驗證失敗請求的正確記錄和報告
  - 測試系統從大量錯誤中的恢復能力

### `test/load/gemini-rate-limit-load.test.ts`

**功能**: Gemini API 限速測試

**詳細實現**:

- **限速觸發測試**：

  - 模擬達到Gemini API每分鐘請求限制的場景
  - 測試系統對429 Too Many Requests響應的處理
  - 驗證自動降速和請求延遲機制
  - 測試限速檢測的準確性和反應速度

- **智能重試機制測試**：

  - 測試遇到限速時的指數回退重試算法
  - 驗證重試間隔的計算和調整（30秒 → 60秒 → 180秒）
  - 測試最大重試次數的控制
  - 驗證重試過程中的狀態維護

- **回退策略測試**：
  - 測試Gemini限速時自動切換到OpenAI的機制
  - 驗證服務商之間的負載均衡和分配
  - 測試回退決策的智能性和效率
  - 驗證用戶體驗的平滑過渡

### `test/load/pdf-parsing-bottleneck.test.ts`

**功能**: PDF 解析瓶頸測試

**詳細實現**:

- **真實瓶頸模擬測試**：

  - 模擬從S3/MinIO存儲檢索大文件的延遲（5-15秒）
  - 測試HTTP POST到解析API的網絡延遲
  - 模擬解析API的排隊等待時間（1-2分鐘）
  - 驗證輪詢機制的效率和資源消耗

- **存儲性能測試**：

  - 測試並發檔案檢索對存儲系統的壓力
  - 驗證大文件下載的帶寬使用和優化
  - 測試存儲連接池的管理和復用
  - 驗證檔案緩存機制的效果

- **解析服務集成測試**：
  - 測試外部PDF解析API的可靠性和性能
  - 驗證解析任務的提交和狀態追蹤
  - 測試長時間運行任務的超時處理
  - 驗證解析結果的完整性和格式

### `test/load/pdf-processing-load.test.ts`

**功能**: PDF 處理負載測試

**詳細實現**:

- **大批量處理測試**：

  - 模擬同時處理20-50個PDF文件的場景
  - 測試文件隊列的管理和優先級排序
  - 驗證處理進度的準確追蹤和報告
  - 測試系統資源的合理分配和使用

- **隊列管理測試**：

  - 測試PDF處理隊列的FIFO/Priority排序算法
  - 驗證隊列容量限制和溢出處理
  - 測試任務的暫停、恢復和取消功能
  - 驗證隊列狀態的持久化和恢復

- **系統穩定性測試**：
  - 測試長時間高負載下的系統穩定性
  - 驗證內存洩漏的預防和檢測
  - 測試文件處理失敗時的清理機制
  - 驗證系統在極限負載下的優雅降級

### `test/load/real-pdf-parsing.test.ts`

**功能**: 真實 PDF 解析測試

**詳細實現**:

- **真實API集成測試**：

  - 使用真實的PDF解析API (gradingpdf.grading.software)
  - 測試真實網絡條件下的API響應時間
  - 驗證API認證和授權機制的正確實現
  - 測試API版本兼容性和錯誤處理

- **實際文件處理測試**：

  - 測試不同類型和大小的真實PDF文件
  - 驗證複雜文檔格式的解析準確性
  - 測試圖片、表格、特殊字符的處理能力
  - 驗證解析結果的文本質量和格式保持

- **服務可靠性測試**：
  - 測試外部解析服務的可用性和穩定性
  - 驗證服務中斷時的錯誤處理和恢復
  - 測試不同時段的服務性能變化
  - 驗證服務SLA的實際表現

## 維護說明

### 添加新測試時的更新步驟

1. 在相應的測試分類下添加新的測試文件說明
2. 描述測試的主要功能和測試場景
3. 如果是新的測試類型，需要添加新的分類章節

### 測試文件命名規範

- **單元測試**: `test/unit/[功能名稱].test.ts`
- **集成測試**: `test/integration/[工作流名稱].test.ts`
- **負載測試**: `test/load/[負載類型].test.ts`

### 文檔更新頻率

當添加新測試文件或重大修改現有測試時，應立即更新此文檔。
