# 評分系統實作計劃 (ToDoList)

## 專案狀態總覽
- 🟢 **資料庫架構**: 已完成設計和測試
- 🟡 **Rubric服務層**: ✅ 已完成重構，適配新schema
- 🔴 **檔案上傳系統**: 尚未開始
- 🔴 **評分會話管理**: 尚未開始
- 🔴 **LLM評分整合**: 尚未開始
- 🔴 **結果展示系統**: 尚未開始

---

## Phase 1: 基礎架構與認證 
**狀態**: ✅ 已完成
- [x] 檢查現有 Google Auth 實作
- [x] 確認使用者認證流程
- [x] 更新資料庫 schema（Prisma）
- [x] 建立測試資料工廠
- [x] 執行完整的整合測試

**完成日期**: 已完成  
**備註**: 所有基礎架構已就緒，測試全部通過

---

## Phase 2: Rubric管理系統 (CRUD操作)
**狀態**: ✅ 已完成重構
**建議**: 這是最穩固的起點，有現有基礎可以擴展

### 2.1 服務層重構 ✅
- [x] 更新 `app/services/rubric.server.ts` 適配新schema
- [x] 支援版本控制 (version, isActive)
- [x] 將 criteria 改為 JSON 存儲格式
- [x] 統一類型導入使用 `@/types/database`
- [x] 新增 `getRubricVersions()` 函數
- [x] 軟刪除機制（isActive=false）
- [x] 關聯性檢查（防止刪除使用中的rubric）

### 2.2 UI層適配 🔄
- [ ] 更新相關 React 元件以支援版本顯示
- [ ] 適配 API 響應格式變更
- [ ] 測試現有 Rubric CRUD 操作

### 2.3 API端點適配 🔄  
- [ ] 檢查 `/api/rubrics/*` 端點是否需要更新
- [ ] 確保類型一致性

**完成日期**: 服務層已完成  
**下一步**: 繼續適配 UI 和 API 層

---

## Phase 3: 檔案上傳系統 (SSE支援)
**狀態**: 🔴 尚未開始

### 3.1 基礎檔案上傳
- [ ] 實作多檔案上傳元件
- [ ] S3/檔案存儲整合
- [ ] 檔案類型驗證

### 3.2 Server-Sent Events (SSE)
- [ ] 建立 SSE 端點 `/api/upload/progress`
- [ ] 實作即時進度追蹤
- [ ] 檔案解析狀態更新

### 3.3 資料庫整合
- [ ] UploadedFile 模型操作
- [ ] 檔案到期機制
- [ ] 解析狀態管理

---

## Phase 4: 評分會話系統
**狀態**: 🔴 尚未開始

### 4.1 會話管理
- [ ] GradingSession CRUD 操作
- [ ] 檔案-Rubric 配對介面
- [ ] 會話狀態追蹤

### 4.2 評分排程
- [ ] 批次評分佇列
- [ ] 進度追蹤系統
- [ ] 錯誤處理與重試

---

## Phase 5: LLM評分整合
**狀態**: 🔴 尚未開始

### 5.1 評分引擎
- [ ] 更新 `gradeDocument` 函數使用新架構
- [ ] GradingResult 模型操作
- [ ] LLM API 整合 (Google GenAI)

### 5.2 結果存儲
- [ ] 評分結果持久化
- [ ] 中繼資料管理
- [ ] 評分歷史追蹤

---

## Phase 6: 結果展示系統 (Carousel)
**狀態**: 🔴 尚未開始

### 6.1 shadcn Carousel 整合
- [ ] 安裝並配置 Carousel 元件
- [ ] 結果卡片設計
- [ ] 響應式佈局

### 6.2 互動功能
- [ ] 評分結果篩選
- [ ] 匯出功能
- [ ] 結果比較模式

---

## Phase 7: 測試與優化
**狀態**: 🔴 尚未開始

### 7.1 端到端測試
- [ ] 完整工作流程測試
- [ ] 效能測試
- [ ] 錯誤情境測試

### 7.2 優化
- [ ] 快取策略
- [ ] 資料庫查詢優化
- [ ] 前端效能優化

---

## Phase 8: 部署與監控
**狀態**: 🔴 尚未開始

### 8.1 部署準備
- [ ] 環境變數配置
- [ ] 資料庫遷移腳本
- [ ] 部署文件

### 8.2 監控
- [ ] 錯誤追蹤
- [ ] 效能監控
- [ ] 使用者行為分析

---

## 技術債務與改進項目

### 已識別問題
1. **服務層**: ✅ 已重構完成
2. **類型系統**: ✅ 已統一使用 `@/types/database`
3. **測試覆蓋率**: ✅ 核心流程已覆蓋

### 待改進項目
1. **UI層適配**: 需要更新相關React元件以支援新的API響應格式
2. **錯誤處理**: 加強前端錯誤處理和使用者回饋
3. **使用者體驗**: 改進載入狀態和進度回饋

---

## 當前重點 🎯

**立即任務**: 
- 完成 Phase 2.2-2.3 (Rubric UI和API適配)
- 檢查並修復現有Rubric CRUD操作
- 確保新服務層與現有前端相容

**下一個里程碑**: Phase 3 檔案上傳系統

**預計時程**: 
- Phase 2 完成: 本週內
- Phase 3-4: 下週
- Phase 5-6: 第三週
- Phase 7-8: 第四週

---

*最後更新: 已完成Rubric服務層重構，測試全部通過*

## 階段 1: 基礎架構 & 認證 🏗️

### 1.1 Google 認證系統
- [ ] 確認現有 Google OAuth 配置
- [ ] 測試登入流程
- [ ] 實作用戶會話管理
- [ ] 添加認證中間件保護 API

### 1.2 基礎 API 結構
- [ ] 更新現有 API routes
- [ ] 實作統一錯誤處理
- [ ] 添加 API 請求驗證
- [ ] 實作用戶權限檢查

## 階段 2: 評分標準管理 (CRUD) 📝

### 2.1 後端 API
- [ ] `GET /api/rubrics` - 獲取用戶的評分標準清單
- [ ] `POST /api/rubrics` - 創建新評分標準
- [ ] `PUT /api/rubrics/:id` - 更新評分標準
- [ ] `DELETE /api/rubrics/:id` - 刪除評分標準
- [ ] 實作評分標準版本控制邏輯

### 2.2 前端組件
- [ ] 評分標準列表組件 (`RubricList`)
- [ ] 評分標準表單組件 (`RubricForm`) 
- [ ] 評分標準詳情組件 (`RubricDetail`)
- [ ] 刪除確認對話框
- [ ] 響應式 UI 設計

### 2.3 頁面實作
- [ ] `/rubrics` - 評分標準管理頁面
- [ ] `/rubrics/new` - 新增評分標準頁面
- [ ] `/rubrics/:id/edit` - 編輯評分標準頁面

## 階段 3: 檔案上傳系統 📁

### 3.1 後端檔案處理
- [ ] 實作檔案上傳 API (`POST /api/upload`)
- [ ] 實作檔案解析服務 (PDF, DOCX, TXT)
- [ ] 實作檔案儲存邏輯 (local/cloud)
- [ ] 添加檔案類型驗證
- [ ] 實作檔案大小限制
- [ ] 實作檔案過期清理

### 3.2 即時進度與 SSE
- [ ] 實作 SSE 端點 (`/api/upload/progress/:id`)
- [ ] 實作檔案解析狀態更新
- [ ] 實作進度計算邏輯
- [ ] 錯誤處理和重試機制

### 3.3 前端上傳組件
- [ ] 多檔案拖拽上傳組件 (`FileUpload`)
- [ ] 即時進度條組件 (`ProgressBar`)
- [ ] 檔案列表組件 (`FileList`)
- [ ] 評分標準選擇器 (`RubricSelector`)
- [ ] 檔案-標準配對界面

## 階段 4: 評分會話系統 🎯

### 4.1 評分會話管理
- [ ] 實作評分會話創建 API
- [ ] 實作檔案-標準配對邏輯
- [ ] 實作會話狀態管理
- [ ] 實作會話進度計算

### 4.2 前端會話界面
- [ ] 評分會話創建界面
- [ ] 檔案-標準配對確認界面
- [ ] 會話進度顯示
- [ ] 送出評分按鈕和確認

## 階段 5: LLM 評分整合 🤖

### 5.1 LLM 服務整合
- [ ] 實作 OpenAI API 客戶端
- [ ] 設計評分提示模板
- [ ] 實作評分請求處理
- [ ] 實作評分結果解析
- [ ] 添加 token 計算和成本控制

### 5.2 評分處理服務
- [ ] 實作背景評分工作
- [ ] 實作評分狀態更新
- [ ] 實作評分結果儲存
- [ ] 實作評分錯誤處理

### 5.3 即時評分進度
- [ ] 實作評分進度 SSE (`/api/grade/progress/:sessionId`)
- [ ] 實作評分狀態廣播
- [ ] 前端即時狀態更新

## 階段 6: 結果顯示系統 🎨

### 6.1 結果 API
- [ ] `GET /api/grading-sessions/:id/results` - 獲取評分結果
- [ ] 實作結果排序和篩選
- [ ] 實作結果匯出功能

### 6.2 Carousel 結果展示
- [ ] 實作 `ResultCarousel` 組件
- [ ] 實作結果卡片設計
- [ ] 實作評分詳情展示
- [ ] 實作分數視覺化
- [ ] 實作評語顯示

### 6.3 結果管理
- [ ] 評分歷史頁面 (`/grading-history`)
- [ ] 結果搜尋和篩選
- [ ] 結果匯出功能
- [ ] 結果分享功能

## 階段 7: 優化與測試 🔧

### 7.1 性能優化
- [ ] API 響應時間優化
- [ ] 檔案上傳性能優化
- [ ] 前端載入優化
- [ ] 資料庫查詢優化

### 7.2 用戶體驗
- [ ] 載入狀態優化
- [ ] 錯誤訊息改善
- [ ] 響應式設計完善
- [ ] 無障礙功能添加

### 7.3 測試完善
- [ ] API 整合測試
- [ ] 前端組件測試
- [ ] 端到端測試
- [ ] 效能測試

## 階段 8: 部署與監控 🚀

### 8.1 部署準備
- [ ] 生產環境配置
- [ ] 環境變數管理
- [ ] 資料庫遷移腳本
- [ ] 靜態資源優化

### 8.2 監控與日誌
- [ ] 錯誤監控設置
- [ ] 性能監控
- [ ] 用戶行為追蹤
- [ ] 系統健康檢查

---

## 實作順序建議

**建議開始順序：**
1. 先從 **階段2 (評分標準管理)** 開始 - 這是最基礎的 CRUD 功能
2. 然後 **階段3 (檔案上傳)** - 建立檔案處理能力  
3. 接著 **階段4 (評分會話)** - 串接檔案和標準
4. 再來 **階段5 (LLM整合)** - 核心評分功能
5. 最後 **階段6 (結果顯示)** - 完整用戶體驗

**每個階段都應該：**
- ✅ 先寫測試
- ✅ 實作後端 API  
- ✅ 實作前端組件
- ✅ 整合測試
- ✅ 用戶測試

---

## 當前狀態 ✅
- [x] 資料庫 Schema 設計完成
- [x] 測試工廠和基礎測試完成
- [x] 專案架構確立
- [x] Types 導入統一化完成 