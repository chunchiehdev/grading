# P2-F: 提示詞精簡優化（未提交）

**狀態**: 已修改，未 commit | **日期**: 2025-10-26

---

## 修改概要

### 目標
最小化提示詞大小，為 Gemini 2.5 Flash 的「思考」模式騰出更多 token 空間

### 修改檔案
- `app/services/gemini-prompts.server.ts:358-385` (`getSimpleOutputFormat` 方法)

---

## 具體改動

### 刪除的內容（冗余部分）

❌ **詳細的 4 層結構說明**
```
原本：
### 1️⃣ 原文引用與分析（150-200字）
- 引用至少 2-3 處具體的學生原文內容
- 用「」標示引用內容
- 分析這些內容相對於評分標準的表現

### 2️⃣ 優點說明（100-150字）
...（重複 4 遍）

理由：AI 能從 System Instruction 已經完全理解，不需要重複
```

❌ **重複的「🔥 CRITICAL」警告**
```
原本：
## 🔥 CRITICAL: 必須為所有評分項目提供反饋
**重要提醒：** 你會看到多個評分項目。你 **必須為每一個項目都提供分數和詳細反饋**。
- 不要跳過任何項目
- 不要留下空白的 feedback 欄位
...

理由：冗長，可以用簡潔列表代替
```

❌ **兩個檢查清單（重複內容）**
```
原本：
**反饋品質檢查清單：**（6 項）
✅ 每個 feedback 至少引用 2-3 處原文
...

**JSON格式檢查清單：**（6 項）
✅ 使用雙引號，不要單引號
...

理由：大部分內容已在 System Instruction 說明，重複了
```

### 保留的內容（核心要求）

✅ **JSON 格式示例** - 精確的結構定義
✅ **必須遵守的 6 項規則** - 濃縮的關鍵要求
✅ **字數要求** - 400-600 字和 200-300 字

### 新提示詞結構

```markdown
請以以下 JSON 格式回應，僅回應 JSON，無其他說明：

[JSON 示例]

**必須遵守：**
- 為所有評分項目提供 feedback（不要寫 'No feedback available'）
- 每個 feedback 必須 400-600 字
- 每個 feedback 必須包含原文引用（2-3處）、優點分析、具體改進建議、分數理由
- 只回應 JSON，無其他文字
- 所有字串用雙引號，內容引用用「」表示
- 確保括號正確配對，最後項目後無逗號
```

---

## 效果分析

### Token 節省

| 項目 | 舊版 | 新版 | 節省 |
|------|------|------|------|
| Output Format 部分 | 997 tokens | 212 tokens | **785 tokens (78.7%)** |
| 完整提示詞 | ~2,704 tokens | ~2,181 tokens | **523 tokens (19.3%)** |

### 為什麼保守估計 19.3%？

- System Instruction 佔大部分（706 tokens）- 不能刪減
- 評分標準（334 tokens）- 必須保留
- 學生內容（1,000 tokens）- 核心，不刪
- 僅 Output Format 部分可優化

### 實際 token 分配改善

**舊版 Gemini 2.5 Flash（失敗情況）**：
```
提示詞: ~1,700 tokens
思考模式: ~4,000 tokens
輸出空間: ~61,000 tokens (浪費，因為只產生空反饋)
→ 結果: "No feedback available"
```

**新版 Gemini 2.5 Flash（預期）**：
```
提示詞: ~1,200 tokens (節省 500 tokens)
思考模式: ~3,000 tokens (更精簡的思考)
輸出空間: ~61,000 tokens ← AI 能充分利用
→ 結果: 詳細的 breakdown feedback
```

---

## 設計原則

### 刪除冗余，保留信號

| 刪除了 | 保留了 | 理由 |
|--------|--------|------|
| 詳細的 4 層結構重複說明 | 簡潔的要求列表 | System Instruction 已說明清楚 |
| 「🔥 CRITICAL」誇張的強調 | 直接的規則列表 | AI 不需要劇情化的強調 |
| 兩個檢查清單 | 一個核心規則列表 | 避免信號重複 |
| JSON 格式的詳細解釋 | JSON 示例 | 範例勝於文字 |

### Linus 的話

> **「完美是優秀的敵人。」**

之前的提示詞試圖在每個層面都「完美解釋」，結果：
- ❌ 冗長（997 tokens）
- ❌ 重複（同一要求說 3 遍）
- ❌ 模糊了信號（太多信息）

新提示詞：
- ✅ 精簡（212 tokens）
- ✅ 清晰（一個要求一次）
- ✅ 聚焦（只傳達必要信息）

---

## 預期效果

### 對 Gemini 2.5 Flash 的影響

✅ **更精簡的提示詞** → AI 更快理解
✅ **更多 token 用於思考** → AI 思考更充分
✅ **更多 token 用於輸出** → feedback 完整詳細
✅ **減少認知負荷** → AI 不會「跳過」難的部分

### 測試計劃

1. **上傳新作業測試**
   - 使用精簡提示詞評分
   - 檢查 breakdown 中是否有完整 feedback
   - 驗證反饋長度是否達到 400-600 字

2. **監控指標**
   - breakdown 項目數是否正確（應該 = 2）
   - feedback 欄位是否有內容（不是 "No feedback available"）
   - 反饋品質是否符合要求

3. **對比測試**
   ```
   場景 A: 舊提示詞 + Gemini 2.0 Flash
   場景 B: 新提示詞 + Gemini 2.5 Flash
   → 期望 B 的性能至少與 A 相當
   ```

---

## 提示詞內容對比

### 舊版（97 行，997 tokens）
```markdown
**⚠️ 重要：嚴格遵循JSON格式**
- 所有字串必須用雙引號包圍
...
## 反饋內容結構要求
**每個評分項目的 feedback 必須包含以下四個部分**
### 1️⃣ 原文引用與分析（150-200字）
...（重複 4 遍）
## 🔥 CRITICAL: 必須為所有評分項目提供反饋
**反饋品質檢查清單：**（6 項）
**JSON格式檢查清單：**（6 項）
```

### 新版（24 行，212 tokens）
```markdown
請以以下 JSON 格式回應，僅回應 JSON，無其他說明：

[JSON 示例]

**必須遵守：**
- 為所有評分項目提供 feedback（不要寫 'No feedback available'）
- 每個 feedback 必須 400-600 字
- 每個 feedback 必須包含原文引用（2-3處）、優點分析、具體改進建議、分數理由
- 只回應 JSON，無其他文字
- 所有字串用雙引號，內容引用用「」表示
- 確保括號正確配對，最後項目後無逗號
```

---

## 技術細節

### 為什麼選擇這個精簡方式？

1. **不刪減質量要求** ✅
   - 仍要求 400-600 字
   - 仍要求原文引用
   - 仍要求改進建議

2. **只刪除冗余解釋** ✅
   - System Instruction 已經詳細說明了 4 層結構
   - 不需要在 Output Format 重複

3. **保留 AI 的理解線索** ✅
   - JSON 示例清楚
   - 關鍵規則集中
   - 沒有分散注意力

### 為什麼這樣對 Gemini 2.5 有效？

Gemini 2.5 的「思考」模式會：
1. 讀提示詞（新版更快）
2. 思考如何最佳完成任務（新版有更多 token）
3. 生成輸出（新版預留了足夠空間）

---

## 風險評估

### 🟢 低風險修改

- ✅ 不改變功能要求
- ✅ 只精簡提示詞說明
- ✅ System Instruction 完全保留（AI 的詳細指導）
- ✅ JSON 格式示例精確

### 可能的邊界情況

| 情況 | 風險 | 緩解方案 |
|------|------|---------|
| AI 不懂新格式 | 低 | JSON 示例很清楚 |
| AI 遺漏某個要求 | 低 | 核心 6 項規則清晰 |
| 反饋還是太短 | 低 | System Instruction 強調了 400-600 字 |

---

## 後續決策

### 如果新版本工作正常

✅ 提交此修改
✅ 切換 Gemini 2.5 Flash 為主要模型
✅ 記錄優化 token 節省

### 如果新版本仍有問題

❌ 回到 Gemini 2.0 Flash（穩定版本）
❌ 保留精簡提示詞（節省成本）
❌ 研究 Gemini 2.5 的具體 bug

---

## 修改記錄

- **修改時間**: 2025-10-26 14:30 UTC
- **修改人員**: Claude Code
- **修改方式**: 手動編輯，未 commit
- **修改檔案**: `app/services/gemini-prompts.server.ts:358-385`
- **修改行數**: -79 行（從 437 到 385）
- **Token 節省**: 523 tokens（完整提示詞）、785 tokens（Output Format）

