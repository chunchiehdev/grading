# 🤖 如何使用 Agent 評分系統

## 🎯 快速開始（3 分鐘）

### 步驟 1：啟用 Agent 評分

編輯 `.env` 檔案：

```bash
# 啟用 Agent 評分
USE_AGENT_GRADING=true

# 確認你的 Gemini API Key
GEMINI_API_KEY=your_actual_key_here
```

### 步驟 2：重啟服務

```bash
docker-compose -f docker-compose.dev.yaml restart app
```

### 步驟 3：測試

1. 訪問 http://localhost:3000
2. 以老師身份登入
3. 提交一份測試作業
4. 啟動評分
5. 等待 10-30 秒
6. 查看評分結果 → 應該看到「AI Agent 執行過程」

---

## 📊 UI 使用指南

### 1. 查看評分結果

評分完成後，在評分詳情頁會看到：

#### 新增區塊：AI Agent 執行過程

```
┌───────────────────────────────────────────┐
│ 🧠 AI Agent 執行過程                      │
│ 多步驟推理評分 · 共 8 個步驟              │
│                                           │
│ [信心度：高 (78%)]  [需審核]             │
├───────────────────────────────────────────┤
│                                           │
│ 📍 步驟 1: 分析評分標準      ⏱️ 1.2s     │
│    AI 推理：評估 rubric 為中等複雜度...   │
│    [查看詳細資訊 ▼]                       │
│                                           │
│ 📍 步驟 2: 解析作業內容      ⏱️ 0.8s     │
│    AI 推理：檢測到程式碼區塊，字數 1580... │
│    [查看詳細資訊 ▼]                       │
│                                           │
│ 📍 步驟 3: 搜尋參考資料      ⏱️ 2.1s     │
│    AI 推理：找到 3 份相關參考文件...      │
│    [查看詳細資訊 ▼]                       │
│                                           │
│ 📍 步驟 4: 檢查相似度        ⏱️ 3.2s     │
│    AI 推理：未發現高相似度作業...         │
│    [查看詳細資訊 ▼]                       │
│                                           │
│ 📍 步驟 5-7: 逐項評分        ⏱️ 8.5s     │
│    AI 推理：根據評分標準逐項評分...       │
│                                           │
│ 📍 步驟 8: 計算信心度        ⏱️ 0.5s     │
│    AI 推理：綜合評估信心度為 0.78...      │
│    [查看詳細資訊 ▼]                       │
│                                           │
│ 📍 步驟 9: 生成反饋          ⏱️ 1.2s     │
│    AI 推理：彙總評分結果...               │
│    [查看詳細資訊 ▼]                       │
│                                           │
├───────────────────────────────────────────┤
│ 統計摘要                                  │
│ 9 執行步驟 | 6 工具調用 | 18.5 秒        │
└───────────────────────────────────────────┘
```

**點擊「查看詳細資訊」可以展開：**
- 工具輸入參數（JSON 格式）
- 工具輸出結果（JSON 格式）
- AI 完整推理過程

---

### 2. 審核佇列（老師專用）

訪問：**http://localhost:3000/teacher/agent-review**

#### 統計面板

```
┌─────────────┬─────────────┬─────────────┐
│ 🕐 待審核   │ ✅ 已審核   │ 平均信心度  │
│    12       │    45       │   78.5%     │
└─────────────┴─────────────┴─────────────┘
```

#### 篩選器

- [**待審核**] - 顯示需要審核的評分
- [已審核] - 顯示已審核的評分
- [全部] - 顯示所有 Agent 評分

#### 評分列表

每個評分卡片包含：

1. **基本資訊**
   - 檔案名稱
   - 評分標準
   - 作業區域

2. **Agent 摘要**
   - 🧠 8 步驟
   - 🟡 信心度：中 (68%)
   - ⚠️ 需審核

3. **評分結果**
   - 總分 / 滿分
   - 百分比
   - 整體評語

4. **完整執行軌跡**
   - 所有步驟的詳細記錄
   - 工具調用輸入輸出
   - AI 推理過程

5. **操作按鈕**
   ```
   [✅ 批准評分]  [❌ 重新評分]  [👁️ 查看詳情]
   ```

---

### 3. 操作說明

#### 批准評分

**何時使用：**
- ✅ 評分合理，反饋具體
- ✅ 各項分數有充分證據
- ✅ 沒有明顯錯誤

**操作：**
1. 點擊「✅ 批准評分」按鈕
2. 評分立即對學生可見
3. 標記為「已審核」

#### 重新評分

**何時使用：**
- ❌ 評分明顯不合理
- ❌ 反饋太籠統
- ❌ AI 誤判學生意圖
- ❌ 相似度檢測誤報

**操作：**
1. 點擊「❌ 重新評分」按鈕
2. 評分重置為 PENDING 狀態
3. 重新進入評分佇列
4. 將使用傳統評分方式（非 Agent）

#### 查看詳情

**操作：**
1. 點擊「👁️ 查看詳情」按鈕
2. 在新分頁開啟完整評分頁面
3. 可查看學生作業原文

---

## ⚙️ 設定調整

### 調整信心度閾值

編輯 `.env`：

```bash
# 預設：0.7（平衡模式）
AGENT_CONFIDENCE_THRESHOLD=0.7
```

**建議值：**

| 閾值 | 模式   | 審核率   | 適用場景               |
| ---- | ------ | -------- | ---------------------- |
| 0.8  | 嚴格   | 40-50%   | 重要考試、畢業論文     |
| 0.7  | 平衡 ⭐ | 20-30%   | 一般作業（推薦）       |
| 0.6  | 寬鬆   | 10-20%   | 練習作業、快速評分需求 |

---

## 🎓 實際使用場景

### 場景 1：期中考試評分

**設定：**
```bash
USE_AGENT_GRADING=true
AGENT_CONFIDENCE_THRESHOLD=0.8  # 嚴格模式
```

**流程：**
1. 學生提交考試答案
2. Agent 自動評分（10-30 秒）
3. ~40% 評分進入審核佇列
4. 老師審核低信心度評分
5. 批准後學生可見成績

**優點：**
- ✅ 快速處理大量作業
- ✅ AI 提供初步評分
- ✅ 老師把關品質
- ✅ 完整審計軌跡

---

### 場景 2：日常作業評分

**設定：**
```bash
USE_AGENT_GRADING=true
AGENT_CONFIDENCE_THRESHOLD=0.7  # 平衡模式
```

**流程：**
1. 學生提交作業
2. Agent 自動評分
3. ~70% 高信心度評分直接完成
4. ~30% 進入審核佇列
5. 老師定期檢查審核佇列

**優點：**
- ✅ 大部分作業自動完成
- ✅ 減少老師工作量
- ✅ 維持評分品質

---

### 場景 3：快速反饋練習

**設定：**
```bash
USE_AGENT_GRADING=true
AGENT_CONFIDENCE_THRESHOLD=0.6  # 寬鬆模式
```

**流程：**
1. 學生提交練習
2. Agent 快速評分
3. ~85% 直接完成
4. ~15% 進入審核
5. 學生立即獲得反饋

**優點：**
- ✅ 快速反饋循環
- ✅ 最少人工介入
- ✅ 適合低風險練習

---

## 📊 效能指標

### 執行時間

- **簡單作業**（Rubric < 5 項）：10-15 秒
- **中等作業**（Rubric 5-8 項）：15-25 秒
- **複雜作業**（Rubric > 8 項）：25-35 秒

### 成本估算

每次 Agent 評分：
- Token 使用：5000-15000 tokens
- Gemini 2.5 Flash 成本：~$0.003（約 NT$0.1）
- 比傳統評分貴 3-5 倍，但準確度顯著提升

### 審核工作量

- 閾值 0.7：預期審核 20-30% 的評分
- 每份審核約需 2-3 分鐘
- 建議每天檢查 1-2 次審核佇列

---

## 🔧 故障排除

### 問題 1：Agent 未啟用

**症狀：**
- 評分仍使用傳統模式
- 沒有「AI Agent 執行過程」

**解決：**
```bash
# 檢查環境變數
cat .env | grep USE_AGENT_GRADING

# 應該顯示：
# USE_AGENT_GRADING=true

# 重啟服務
docker-compose -f docker-compose.dev.yaml restart app
```

---

### 問題 2：審核佇列頁面 404

**症狀：**
- 訪問 `/teacher/agent-review` 顯示 404

**解決：**
```bash
# 重新生成路由
npx react-router typegen

# 重啟
npm run dev
```

---

### 問題 3：所有評分都需審核

**症狀：**
- 審核佇列爆滿
- 信心度都很低

**原因：**
- Rubric 標準不夠明確
- 缺少參考資料

**解決：**
1. 優化 Rubric 描述（更具體）
2. 提供參考資料（講義、範例）
3. 降低閾值（0.7 → 0.6）

---

### 問題 4：評分失敗

**症狀：**
- 狀態顯示 FAILED
- 錯誤：「Agent grading failed」

**檢查日誌：**
```bash
docker-compose -f docker-compose.dev.yaml logs app --tail=100 | grep Agent
```

**常見錯誤：**
- `All Gemini API keys are throttled` → 等待 1 分鐘
- `Agent did not generate final feedback` → 檢查 Rubric 格式
- `Tool execution failed` → 查看具體工具錯誤

---

## 🎯 最佳實踐

### 1. Rubric 設計

**好的 Rubric 特徵：**
- ✅ 明確的評分標準
- ✅ 具體的分數描述
- ✅ 量化指標
- ✅ 避免模糊詞彙

**範例對比：**

❌ **不好：**
```
內容品質
- 4 分：很好
- 3 分：不錯
- 2 分：普通
- 1 分：不好
```

✅ **好：**
```
論述深度
- 4 分：完整論述，包含 5+ 例子，深入分析
- 3 分：清楚論述，包含 3-4 例子，基本分析
- 2 分：簡單論述，1-2 例子，缺乏分析
- 1 分：不完整論述，無例子或分析
```

---

### 2. 提供參考資料

在作業設定中添加：
- 📝 課程講義（關鍵概念）
- 📄 範例作業（標準答案）
- 📚 評分說明（評分細則）

**限制：**
- 最多 5 份參考文件
- 每份不超過 5000 字元

---

### 3. 審核效率

**優先順序：**
1. 信心度 < 0.5（最可疑）
2. 相似度警告（抄襲）
3. 信心度 0.5-0.7（中等）

**批次操作：**
- 快速瀏覽所有待審核
- 明顯合理的批量批准
- 有問題的仔細檢查

---

## 📚 完整文檔

- **[快速開始](./docs/AGENT_QUICK_START.md)** - 5 分鐘啟用
- **[詳細指南](./docs/AGENT_GRADING_GUIDE.md)** - 完整功能說明
- **[實作總結](./AGENT_IMPLEMENTATION_SUMMARY.md)** - 技術細節

---

## 🙋 常見問題

**Q: Agent 評分會取代老師嗎？**
A: 不會。Agent 是輔助工具，低信心度評分仍需老師審核。

**Q: 可以只針對特定作業啟用嗎？**
A: 目前是全局設定。如需針對特定作業，需在代碼中添加判斷邏輯。

**Q: 信心度如何計算？**
A: 綜合 Rubric 覆蓋率（40%）、證據品質（40%）、標準模糊度（20%）。

**Q: 可以調整工具行為嗎？**
A: 可以。編輯 `app/services/agent-tools.server.ts`。

**Q: 支援多語言嗎？**
A: 支援。Agent 會根據 `userLanguage` 調整 prompt。

---

**祝你使用愉快！🎉**

有問題請查看完整文檔或檢查日誌：
```bash
docker-compose -f docker-compose.dev.yaml logs app | grep Agent
```
