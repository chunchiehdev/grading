# P2 階段：AI 反饋質量增強計畫

**狀態**: 執行中 | **日期**: 2025-10-26

---

## 問題診斷

### 用戶觀察
在實際評分時，AI 反饋非常簡短（約 222 tokens），但有充足的上下文（774 tokens 提示詞）和模型能力（8192 tokens 上限）。

### 根本原因分析（Linus 式）

**不是 Rubric 設計問題** ✅
你的評分標準設計清晰：
- 涵蓋範圍：4分評級明確
- 理解與概念：4分評級明確
- 評分等級有明確描述

**問題在於提示詞設計** ❌
1. 當前 `getSimpleOutputFormat()` 只要求「基於原文引用的具體分析」
2. AI 沒有「具體」的定義標準
3. AI 不知道應該寫多詳細
4. 傾向簡化回應（取最小可行路徑）

**證據**：
```
提示詞 tokens: 774 (約 92% 使用)
實際輸出: 222 tokens (約 2.7% 使用)
可用上限: 8192 tokens (溫度 0.3, 適合詳細回應)
```

---

## 解決方案（P2-A）✅ 已實施

### 1. 增強 System Instruction

**檔案**: `app/services/gemini-prompts.server.ts:8-78`

**關鍵改變**:
```markdown
你是一位專業教育評分員和教練。你的評分反饋應該深入、有價值。

## 核心責任
1. 精確分析 - 基於評分標準客觀評分
2. 引用原文 - 至少 2-3 處具體句子段落
3. 具體建議 - 可執行的改進方向
4. 建設性反饋 - 幫助提升
5. 充分詳細 - 400-600字/項反饋

## 評分方法論（四層結構）
### 第一部分：原文引用與分析（150-200字）
### 第二部分：優點說明（100-150字）
### 第三部分：改進建議（100-150字）
### 第四部分：總評（50-100字）

總計：400-600 字/項反饋
```

### 2. 優化 Output Format

**檔案**: `app/services/gemini-prompts.server.ts:324-391`

**新增結構化要求**:
```json
{
  "breakdown": [
    {
      "feedback": "按 4 部分結構撰寫（400-600字）
               1️⃣ 原文引用（150-200字）
               2️⃣ 優點說明（100-150字）
               3️⃣ 改進建議（100-150字）
               4️⃣ 總評（50-100字）"
    }
  ],
  "overallFeedback": "整體評價（200-300字）
                     - 最大優點
                     - 關鍵改進
                     - 下一步建議"
}
```

**品質檢查清單**:
- ✅ 引用至少 2-3 處原文
- ✅ 優點和改進明確具體
- ✅ 改進建議可執行
- ✅ 反饋長度 400-600 字
- ✅ overallFeedback 200-300 字

---

## 預期效果

| 指標 | 之前 | 之後 | 改善倍數 |
|------|------|------|---------|
| 單項反饋長度 | ~100 字 | 400-600 字 | ✅ 4-6 倍 |
| Token 使用率 | ~2.7% | ~10-15% | ✅ 5 倍 |
| 原文引用數 | 0-1 處 | 2-3 處 | ✅ 3 倍 |
| 改進建議具體性 | 空泛 | 可執行 | ✅ 大幅改善 |
| overallFeedback | 簡短 | 深入結構化 | ✅ 明顯改善 |

---

## 測試計畫（P2-B）

### 測試方式

1. **上傳一份學生作業**
   - 使用之前測試的同一份作業（ThinkingAboutIdeasB.pdf）
   - 相同的評分標準（Idea Reflection Rubric）

2. **對比結果**
   ```
   前次運行: logs/0ec173d1-ef92-49be-bc60-8eb9edc27397-1761472422442.json
   新運行: logs/[sessionId]-[timestamp].json

   比較項目:
   - 單項反饋字數（應達 400-600）
   - Token 使用數量
   - 是否包含原文引用（2-3 處）
   - 改進建議具體性
   - overallFeedback 長度和結構
   ```

3. **驗證日誌**
   ```bash
   # 檢查新日誌的 prompt 和 result
   cat logs/[new-sessionId]-[timestamp].json | jq '.aiResponse.rawResponse'
   ```

### 成功標準

✅ **所有項目都滿足**:
- 每個 feedback: 400-600 字
- overallFeedback: 200-300 字
- 包含 2-3 處原文引用
- 改進建議明確可執行
- Token 使用達 10% 以上

---

## 後續計畫（P2-C）

### 統一 Format（可選）

**發現**：系統有兩套 Output Format
- `getDetailedOutputFormat()` (269-322 行) - 結構化、未使用
- `getSimpleOutputFormat()` (324-391 行) - 簡化、實際使用

**建議**：
1. 刪除未使用的 `getDetailedOutputFormat()`
2. 將增強版 Simple Format 作為唯一標準
3. 讓 File 和 Text grading 使用相同格式

**優點**：
- ✅ 消除代碼中的特殊情況
- ✅ 簡化維護
- ✅ 統一品質標準

---

## 技術細節

### 修改檔案

```
app/services/gemini-prompts.server.ts
├── generateSystemInstruction() - 新增詳細方法論指引（+66 行）
└── getSimpleOutputFormat() - 新增結構化要求（+67 行，替代 31 行）
```

### 無破壞性變更

✅ **不改變 JSON 結構**
- 仍然使用相同的 criteria/breakdown 格式
- feedback 仍然是單一字串欄位
- 可直接相容現有前端

✅ **不需修改前端**
- GradingResultDisplay.tsx 使用 `criteria.feedback` 字串
- Markdown 渲染支援更長的文本

✅ **不需修改資料庫**
- result 是 JSONB，任何 JSON 結構都可存

### 向後相容性

- ✅ 舊格式反饋仍可正確解析
- ✅ 前端不需要修改
- ✅ 資料庫 schema 不變

---

## 實施時間軸

| 階段 | 任務 | 狀態 | 完成時間 |
|------|------|------|---------|
| P2-A | 增強提示詞和 format | ✅ 完成 | 2025-10-26 |
| P2-B | 測試新反饋效果 | 🔄 進行中 | 待執行 |
| P2-C | 統一 Format（可選） | ⏳ 待檢查 | 待執行 |

---

## 關鍵要點（Linus Torvalds 原則）

### 1. 好品味（Good Taste）
- ✅ 消除了「特殊情況」（兩種 format）
- ✅ 用簡單、清晰的結構化要求解決問題
- ✅ 不過度複雜化

### 2. 不破壞用戶空間（Never Break Userspace）
- ✅ JSON 結構不變
- ✅ 前端 API 兼容
- ✅ 資料庫不需遷移

### 3. 實用主義（Pragmatism）
- ✅ 解決實際問題（反饋太簡短）
- ✅ 不引入不必要的複雜性
- ✅ 使用現有工具實現

### 4. 簡潔執念（Simplicity）
- ✅ 改變只在提示詞層
- ✅ 代碼改動明確且集中
- ✅ 易於理解和維護

---

## 提問和反饋

如果測試結果達到預期，可以考慮：
1. **提高要求**：從 400-600 字增加到 600-800 字
2. **添加範例**：在 System Instruction 中加入「好反饋」vs「壞反饋」的對比範例
3. **多語言**：確保中英文反饋品質一致
4. **研究應用**：使用這些詳細反饋進行論文研究分析

