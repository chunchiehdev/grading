# Implementation Plan: Sleek Course Enrollment UI

**Branch**: `008-specify-scripts-bash` | **Date**: 2025-10-20 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/008-specify-scripts-bash/spec.md`

**Note**: This plan is generated by `/speckit.plan` command. Phases 0-1 below provide technical design and research foundations for implementation.

## Summary

**Objective**: Redesign the teacher invitation display component to be sleek and properly positioned, while creating a new student course discovery page that enables students to browse and directly enroll in all available courses offered by teachers on the platform.

**Scope**:
- **UI Component Redesign**: InvitationDisplay (single-column centered layout with QR code prominence)
- **New Feature**: Course discovery & enrollment page for students (`/student/courses/discover`)
- **Backend Support**: API endpoints for course discovery and enrollment management
- **Database**: Query optimization for discoverability (minimal schema changes expected)

**Technical Approach**:
- Use existing React Router v7 + Tailwind CSS component library for UI consistency
- Leverage existing Prisma relationships (Course → Class → Enrollment) without major migrations
- Create two API endpoints: GET `/api/courses/discover` and POST `/api/enrollments`
- Apply design system tokens (primary, secondary, accent colors) consistently across new components

## Technical Context

**Language/Version**: TypeScript 5.x with React 19
**Primary Dependencies**: React Router v7, React 19, Radix UI, Tailwind CSS, Prisma ORM, Express.js
**Storage**: PostgreSQL (existing database with Course, Class, Enrollment, User models)
**Testing**: Vitest + React Testing Library + MSW for API mocking
**Target Platform**: Web application (React Router v7 with server-side rendering support)
**Project Type**: Web (monolithic React Router v7 application with Node.js backend)
**Performance Goals**: Course discovery page loads in <2 seconds; QR code scannable at 200x200px minimum; <3 clicks to enroll
**Constraints**: WCAG AA contrast ratios (4.5:1) in light/dark modes; responsive 320px-4K; zero duplicate enrollments under rapid clicks
**Scale/Scope**: 10k+ active users; 100+ courses with multiple sections; per-class capacity limits

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**Note**: The project constitution file is currently a template (`constitution.md`). This feature check validates against established project patterns in CLAUDE.md:

✅ **Project Pattern Alignment**:
- **Architecture**: Follows React Router v7 file-based routing with role-based access (/student vs /teacher routes) ✓
- **Service Layer**: Uses `.server.ts` suffix for server-side code with type exports ✓
- **State Management**: Uses Zustand with persistence for UI state ✓
- **Database**: Leverages existing Prisma schema with Course/Class/Enrollment models ✓
- **API Design**: Uses centralized error handling with descriptive messages ✓
- **Testing**: Aligns with Vitest + React Testing Library pattern ✓
- **Internationalization**: Can leverage existing i18next integration with new translation keys ✓

✅ **No Constitution Violations**: Feature uses established patterns without requiring new projects, frameworks, or architectural changes.

## Project Structure

### Documentation (this feature)

```
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```
app/
├── routes/
│   ├── teacher/
│   │   └── courses/
│   │       └── $courseId.tsx              # Existing - modify InvitationDisplay
│   │
│   └── student/
│       ├── courses/
│       │   ├── index.tsx                  # Existing - my enrolled courses
│       │   └── discover.tsx               # NEW - course discovery page
│       │
│       └── layout.tsx                     # Existing - load student context

├── components/
│   ├── ui/
│   │   ├── invitation-display.tsx         # MODIFY - sleek redesign
│   │   ├── copyable-field.tsx             # Existing
│   │   └── qr-display.tsx                 # Existing
│   │
│   └── student/
│       └── CourseDiscoveryContent.tsx     # NEW - course discovery component

├── services/
│   ├── course-detail.server.ts            # Existing
│   ├── course-discovery.server.ts         # NEW - fetch all discoverable courses
│   └── enrollment.server.ts               # NEW - manage student enrollments

├── api/
│   ├── courses/
│   │   └── discover.ts                    # NEW - GET /api/courses/discover endpoint
│   │
│   └── enrollments.ts                     # NEW - POST /api/enrollments endpoint

├── schemas/
│   ├── course.ts                          # Existing
│   └── enrollment.ts                      # NEW - Zod validation for enrollment

└── locales/
    ├── en/
    │   └── course.json                    # Existing - add discovery keys
    │
    └── zh/
        └── course.json                    # Existing - add discovery keys

prisma/
├── schema.prisma                          # Review for query optimization
└── migrations/
    └── [no migrations needed - uses existing models]

tests/
├── routes/
│   └── student/
│       └── courses/
│           └── discover.test.tsx          # NEW - discovery page tests
│
├── api/
│   └── courses/
│       └── discover.test.ts               # NEW - API endpoint tests
│
└── services/
    └── course-discovery.server.test.ts    # NEW - service logic tests
```

**Structure Decision**: Web application feature implementation following established patterns:
- **Backend routes** use `.server.ts` naming convention for type safety and SSR support
- **Frontend components** remain in `components/` organized by feature area (ui/ for reusable, student/ for feature-specific)
- **API endpoints** in `/api/` directory with Express-style routing
- **Service layer** separates business logic from routes and components
- **Tests** mirror source structure with `.test.ts`/`.test.tsx` suffixes
- **No database migrations** needed - leverages existing Course/Class/Enrollment relationships

---

## Phase 0: Research & Clarification

**Status**: ✅ COMPLETE - No unknowns requiring research

**Clarifications Resolved**:

1. **Waiting List Feature** - Resolved ✓
   - **Decision**: MVP excludes waiting list functionality
   - **Rationale**: Keeps initial scope manageable; "Class Full" message with teacher contact suggestion sufficient for launch
   - **Fallback**: Students see disabled "Class Full" message, not enrollment failure
   - **Future**: Waiting list can be added as enhancement in subsequent iteration

2. **Database Schema Changes** - Resolved ✓
   - **Decision**: No schema migrations required
   - **Rationale**: Existing Course → Class → Enrollment relationships already support required queries
   - **Verification**: Verified in `/prisma/schema.prisma` - all relationships exist with proper foreign keys
   - **Query Optimization**: Index on `Course.isActive`, `Class.isActive`, `Class.courseId` may improve discovery query performance (optional)

3. **API Endpoint Patterns** - Resolved ✓
   - **Decision**: Follow existing REST patterns with Express.js
   - **Endpoints**:
     - GET `/api/courses/discover` - fetches discoverable courses with enrollment status
     - POST `/api/enrollments` - creates new enrollment record
   - **Error Handling**: Use existing `ApiError` class and `withErrorHandler` wrapper

4. **UI Component Library** - Resolved ✓
   - **Decision**: Use existing Radix UI + Tailwind CSS + shadcn/ui pattern
   - **Color System**: Leverage existing CSS variables (primary, secondary, accent, muted, etc.)
   - **Components**: Button, Card, CardContent, CardHeader, CardTitle already exist and used consistently

5. **Dark Mode Support** - Resolved ✓
   - **Decision**: Automatic via Tailwind's `dark:` prefix and existing theme configuration
   - **Testing**: Manual contrast ratio verification at build time or via accessibility audit tools
   - **Compliance**: Target WCAG AA (4.5:1 for normal text, 3:1 for large text)

---

## Phase 1: Design & Contracts

### 1.1 Data Model (`data-model.md`)

**Entities Used** (no new models needed):

| Entity | Fields | Relationships | Notes |
|--------|--------|---------------|-------|
| **Course** | id, name, description, code, teacherId, isActive | Teacher (User), Classes[], AssignmentAreas[], InvitationCodes[] | Used for discovery filtering |
| **Class** | id, courseId, name, schedule (JSON), capacity, isActive | Course, Enrollments[], Students (via Enrollment) | Per-section capacity limits |
| **Enrollment** | id, studentId, classId, enrollmentDate, status | Student (User), Class | Unique constraint (studentId, classId) |
| **User** | id, email, name, picture, role | Courses[] (teacher), Enrollments[] (student) | Role enum: TEACHER/STUDENT |
| **InvitationCode** | id, code, courseId, classId, expiresAt, usedCount | Course, Class | Optional - alternative to discovery |

**Queries Needed**:

```
1. GetDiscoverableCourses(studentId)
   - Returns all courses with isActive=true AND has ≥1 active class
   - Includes: course info, teacher info, classes with capacity/enrollment count
   - Excludes: courses already enrolled in (via LEFT JOIN check)

2. CheckEnrollmentEligibility(studentId, classId)
   - Verify: class exists, has capacity, student not already enrolled
   - Returns: capacity status, current enrollment count

3. CreateEnrollment(studentId, classId)
   - Insert enrollment record with transaction
   - Enforce unique constraint (studentId, classId)
   - Verify capacity not exceeded
```

**Validation Rules**:

- Course must have at least one active class to be discoverable
- Enrollment capacity is per-class, not per-course
- Students cannot enroll twice in the same class (unique constraint)
- Enrollment respects capacity limits atomically

### 1.2 API Contracts (`contracts/`)

**Endpoint 1: GET /api/courses/discover**

```typescript
Request Query Parameters:
  - studentId: string (from auth context)
  - limit?: number (default 50, max 100)
  - offset?: number (default 0)
  - sort?: "newest" | "teacher" | "name" (default "newest")
  - search?: string (optional course name/teacher search)

Response (200 OK):
{
  success: true,
  data: {
    courses: [
      {
        id: string,
        name: string,
        description: string,
        code: string,
        teacher: {
          id: string,
          name: string,
          email: string,
          picture: string | null
        },
        classes: [
          {
            id: string,
            name: string,
            schedule: {
              weekday: string,
              periodCode: string,
              room: string
            },
            capacity: number | null,
            enrollmentCount: number,
            isFull: boolean
          }
        ],
        enrollmentStatus: "not_enrolled" | "enrolled",
        createdAt: string (ISO 8601)
      }
    ],
    total: number,
    hasMore: boolean
  }
}

Error Responses:
  - 400 Bad Request: Invalid query parameters
  - 401 Unauthorized: Student not authenticated
  - 500 Internal Server Error: Database query failed
```

**Endpoint 2: POST /api/enrollments**

```typescript
Request Body:
{
  studentId: string (from auth context),
  classId: string,
  courseId: string (for reference)
}

Response (201 Created):
{
  success: true,
  data: {
    enrollment: {
      id: string,
      studentId: string,
      classId: string,
      enrollmentDate: string (ISO 8601),
      status: "active"
    }
  }
}

Error Responses:
  - 400 Bad Request: Invalid request body
  - 409 Conflict: Student already enrolled | Class capacity full
  - 404 Not Found: Class not found | Course not found
  - 401 Unauthorized: Student not authenticated
  - 500 Internal Server Error: Database transaction failed
```

### 1.3 Component Contracts

**Component: InvitationDisplay (Redesigned)**

```typescript
interface InvitationDisplayProps {
  code: string;
  qrCodeUrl: string;
  baseUrl: string;
  codeLabel: string;          // i18n label
  urlLabel: string;            // i18n label
  qrDescription?: string;      // i18n description
}

// Single-column centered layout
// QR code: 200x200px minimum, positioned prominently
// Code/URL: copyable fields with feedback
// Responsive: stacks vertically on mobile
// Colors: primary/secondary from design system
// Dark mode: automatic color inversion
```

**Component: CourseDiscoveryContent (New)**

```typescript
interface CourseDiscoveryContentProps {
  student: {
    id: string;
    email: string;
  };
  courses: DiscoverableCourse[];
  enrolledCourseIds: Set<string>;
}

// Grid layout responsive to viewport
// Course cards with: name, teacher info, schedule, capacity, CTA button
// CTA button states: "Enroll" | "Enrolled" | "Class Full"
// Empty state when no courses
// Optional search/filter bar
```

### 1.4 Quick Start (`quickstart.md`)

**For Implementation Team**:

1. **Start InvitationDisplay Redesign**
   - File: `app/components/ui/invitation-display.tsx`
   - Change grid to flex column with centered content
   - QR code first, then code/URL fields below
   - Use existing `CopyableField` and `QRDisplay` components
   - Test responsive layout down to 320px

2. **Create Course Discovery Route**
   - File: `app/routes/student/courses/discover.tsx`
   - Loader: Fetch all discoverable courses + student enrollments
   - Action: Handle enrollment form submissions
   - Use `CourseDiscoveryContent` component
   - Add i18n keys: `course:discovery.{title,empty,enroll,enrolled,classFull}`

3. **Implement Backend Service**
   - File: `app/services/course-discovery.server.ts`
   - Export `getDiscoverableCourses(studentId, options)` function
   - Export `createEnrollment(studentId, classId)` function
   - Handle error cases: duplicate, capacity, not found

4. **Create API Endpoints**
   - Files: `app/api/courses/discover.ts`, `app/api/enrollments.ts`
   - Use Express Router pattern
   - Apply `withErrorHandler` middleware
   - Validate requests with Zod schemas

5. **Update Translations**
   - Add `course.json` keys for discovery page
   - Both `en` and `zh` locales
   - Keys: title, empty_message, enroll_button, enrolled_badge, class_full_message

6. **Write Tests**
   - Discovery route: test loader data, error cases
   - API endpoints: test success, validation, capacity limits
   - Components: test render, responsive behavior, interactions
   - Services: test query results, constraint enforcement

---



