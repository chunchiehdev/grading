name: Docker CI/CD
on:
  push:
    branches:
      - "master"
      - "development"

permissions:
  contents: write
  packages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'master' && 'production' || 'development' }}
    steps:
    - name: Start Deployment
      run: |
        echo "üöÄ Starting deployment - Branch: ${{ github.ref_name }}"

    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    # ============================================
    # Version Management
    # ============================================
    - name: Auto-update version based on commit message
      id: version-update
      run: |
        COMMIT_MSG=$(cat <<'EOF'
        ${{ github.event.head_commit.message }}
        EOF
        )
        COMMIT_FIRST_LINE=$(echo "$COMMIT_MSG" | head -n 1)

        if [ "${{ github.ref_name }}" = "master" ]; then
          if [[ "$COMMIT_FIRST_LINE" =~ ^feat(\(.+\))?!: ]] || [[ "$COMMIT_FIRST_LINE" =~ BREAKING.CHANGE ]]; then
            npm run version:major && echo "BUMP_TYPE=major" >> $GITHUB_OUTPUT
          elif [[ "$COMMIT_FIRST_LINE" =~ ^feat(\(.+\))?: ]]; then
            npm run version:minor && echo "BUMP_TYPE=minor" >> $GITHUB_OUTPUT
          elif [[ "$COMMIT_FIRST_LINE" =~ ^fix(\(.+\))?: ]] || [[ "$COMMIT_FIRST_LINE" =~ ^perf(\(.+\))?: ]]; then
            npm run version:patch && echo "BUMP_TYPE=patch" >> $GITHUB_OUTPUT
          else
            echo "BUMP_TYPE=none" >> $GITHUB_OUTPUT
          fi
        else
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          BASE_VERSION=$(echo "$CURRENT_VERSION" | sed 's/-dev\.[0-9]*$//')
          npm version "$BASE_VERSION" --no-git-tag-version --allow-same-version
          if [[ "$COMMIT_FIRST_LINE" =~ ^feat(\(.+\))?: ]]; then
            npm version minor --no-git-tag-version
          elif [[ "$COMMIT_FIRST_LINE" =~ ^fix(\(.+\))?: ]] || [[ "$COMMIT_FIRST_LINE" =~ ^perf(\(.+\))?: ]]; then
            npm version patch --no-git-tag-version
          fi
          NEW_BASE=$(node -p "require('./package.json').version")
          npm version "${NEW_BASE}-dev.$(date +%Y%m%d%H%M)" --no-git-tag-version
          echo "BUMP_TYPE=dev" >> $GITHUB_OUTPUT
        fi

    - name: Get version
      id: package-version
      run: echo "VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

    - name: Commit and push version bump
      if: steps.version-update.outputs.BUMP_TYPE != 'none'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add package.json
        git commit -m "chore: bump version to ${{ steps.package-version.outputs.VERSION }} [skip ci]"
        git push origin ${{ github.ref_name }}

    # ============================================
    # Docker Build
    # ============================================
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}

    - name: Build and push Main App
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          chunchiehdev/gradsystem:${{ github.ref_name }}
          chunchiehdev/gradsystem:${{ steps.package-version.outputs.VERSION }}-${{ github.ref_name }}
        build-args: |
          BUILD_VERSION=${{ steps.package-version.outputs.VERSION }}
          BUILD_BRANCH=${{ github.ref_name }}
          BUILD_COMMIT=${{ github.sha }}

    - name: Build and push WebSocket Server
      uses: docker/build-push-action@v5
      with:
        context: ./websocket-server
        push: true
        tags: |
          chunchiehdev/websocket-server:${{ github.ref_name }}
          chunchiehdev/websocket-server:${{ steps.package-version.outputs.VERSION }}-${{ github.ref_name }}

    # ============================================
    # Setup Tools
    # ============================================
    - name: Setup kubectl & Kustomize
      run: |
        curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
        chmod +x kubectl && sudo mv kubectl /usr/local/bin/
        curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
        sudo mv kustomize /usr/local/bin/

    - name: Prepare kubeconfig files
      run: |
        echo "${{ secrets.KUBE_CONFIG_K3S }}" | base64 -d > kubeconfig_k3s
        echo "${{ secrets.KUBE_CONFIG_MARS }}" | base64 -d > kubeconfig_mars
        chmod 600 kubeconfig_k3s kubeconfig_mars

    # ============================================
    # Deploy to K3s
    # ============================================
    - name: Set K3s variables
      id: k3s
      run: |
        if [ "${{ github.ref_name }}" = "master" ]; then
          echo "OVERLAY=k8s/main-service/overlays/prod-k3s" >> $GITHUB_OUTPUT
          echo "NS=default" >> $GITHUB_OUTPUT
        else
          echo "OVERLAY=k8s/main-service/overlays/dev-k3s" >> $GITHUB_OUTPUT
          echo "NS=dev" >> $GITHUB_OUTPUT
        fi

    - name: Generate K3s secrets
      run: |
        if [ "${{ github.ref_name }}" = "master" ]; then
          printf "%s" "${{ secrets.PROD_K3S_ENV_FILE }}" > ${{ steps.k3s.outputs.OVERLAY }}/.secrets.env
        else
          printf "%s" "${{ secrets.DEV_K3S_ENV_FILE }}" > ${{ steps.k3s.outputs.OVERLAY }}/.secrets.env
        fi

    - name: Update K3s image tag
      run: |
        cd ${{ steps.k3s.outputs.OVERLAY }}
        kustomize edit set image chunchiehdev/gradsystem=chunchiehdev/gradsystem:${{ github.ref_name }}

    - name: Deploy & Migrate (K3s)
      env:
        KUBECONFIG: ./kubeconfig_k3s
      run: |
        OVERLAY="${{ steps.k3s.outputs.OVERLAY }}"
        NS="${{ steps.k3s.outputs.NS }}"
        
        # Determine job name based on environment
        if [ "${{ github.ref_name }}" = "master" ]; then
          JOB_NAME="db-migrate"
        else
          JOB_NAME="db-migrate-dev"
        fi
        
        # Delete old migration job if exists
        kubectl delete job $JOB_NAME -n $NS --ignore-not-found
        
        # Apply all resources (Deployment, Service, Secret, Job)
        kubectl apply -k $OVERLAY
        
        # Wait for migration job
        echo "‚è≥ Waiting for migration..."
        kubectl wait --for=condition=complete job/$JOB_NAME -n $NS --timeout=600s || {
          echo "‚ùå Migration job timed out or failed"
          echo "üìã Job logs:"
          kubectl logs -l app.kubernetes.io/component=migration -n $NS --tail=100
          exit 1
        }
        
        # Wait for deployment rollout
        echo "‚è≥ Waiting for rollout..."
        kubectl rollout status deployment -n $NS -l app.kubernetes.io/name=gradsystem --timeout=300s
        
        echo "‚úÖ K3s deployment complete!"

    # ============================================
    # Deploy to Mars K8s (development only)
    # ============================================
    - name: Generate Mars secrets
      if: github.ref_name == 'development'
      run: |
        if [ "${{ github.ref_name }}" = "master" ]; then
          OVERLAY="k8s/main-service/overlays/prod-k8s"
          printf "%s" "${{ secrets.PROD_K8S_ENV_FILE }}" > $OVERLAY/.secrets.env
        else
          OVERLAY="k8s/main-service/overlays/dev-k8s"
          printf "%s" "${{ secrets.DEV_K8S_ENV_FILE }}" > $OVERLAY/.secrets.env
        fi

    - name: Update Mars image tag
      if: github.ref_name == 'development'
      run: |
        if [ "${{ github.ref_name }}" = "master" ]; then
          OVERLAY="k8s/main-service/overlays/prod-k8s"
        else
          OVERLAY="k8s/main-service/overlays/dev-k8s"
        fi
        cd $OVERLAY
        kustomize edit set image chunchiehdev/gradsystem=chunchiehdev/gradsystem:${{ github.ref_name }}

    - name: Deploy & Migrate (Mars)
      if: github.ref_name == 'development'
      env:
        KUBECONFIG: ./kubeconfig_mars
      run: |
        # Determine overlay and namespace based on environment
        if [ "${{ github.ref_name }}" = "master" ]; then
          OVERLAY="k8s/main-service/overlays/prod-k8s"
          NS="default"
          JOB_NAME="db-migrate"
        else
          OVERLAY="k8s/main-service/overlays/dev-k8s"
          NS="gradsystem-dev"
          JOB_NAME="db-migrate-dev"
        fi
        
        kubectl delete job $JOB_NAME -n $NS --ignore-not-found
        kubectl apply -k $OVERLAY
        
        echo "‚è≥ Waiting for Mars migration..."
        kubectl wait --for=condition=complete job/$JOB_NAME -n $NS --timeout=600s || {
          echo "‚ùå Migration job timed out or failed"
          echo "üìã Job logs:"
          kubectl logs -l app.kubernetes.io/component=migration -n $NS --tail=100
          exit 1
        }
        
        echo "‚è≥ Waiting for Mars rollout..."
        kubectl rollout status deployment -n $NS -l app.kubernetes.io/name=gradsystem --timeout=300s
        
        echo "‚úÖ Mars deployment complete!"

    # ============================================
    # Cleanup & Tagging
    # ============================================
    - name: Cleanup secrets
      if: always()
      run: rm -f k8s/main-service/overlays/*/.secrets.env kubeconfig_*

    - name: Create git tag
      if: steps.version-update.outputs.BUMP_TYPE != 'none'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a v${{ steps.package-version.outputs.VERSION }} -m "Release v${{ steps.package-version.outputs.VERSION }}"
        git push origin v${{ steps.package-version.outputs.VERSION }}

    - name: Summary
      run: |
        echo "========================================"
        echo "‚úÖ Deployment Complete"
        echo "Version: ${{ steps.package-version.outputs.VERSION }}"
        echo "K3s: ‚úÖ | Mars: ${{ github.ref_name == 'development' && '‚úÖ' || '‚è≠Ô∏è (skipped)' }}"
        echo "========================================"
